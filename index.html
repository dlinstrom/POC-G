<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Water Level Monitor - 3 Sensors</title>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}
body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
background: linear-gradient(135deg, #2d5016 0%, #68a225 100%);
min-height: 100vh;
padding: 10px;
-webkit-text-size-adjust: 100%;
-webkit-font-smoothing: antialiased;
}
@media (min-width: 768px) {
body {
padding: 20px;
}
}
.container {
background: rgba(255, 255, 255, 0.95);
border-radius: 15px;
box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
padding: 15px;
max-width: 1400px;
margin: 0 auto;
}
@media (min-width: 768px) {
.container {
border-radius: 20px;
padding: 30px;
}
}
h1 {
color: #333;
text-align: center;
margin-bottom: 15px;
font-size: 1.8em;
line-height: 1.2;
}
@media (min-width: 768px) {
h1 {
font-size: 2.2em;
margin-bottom: 20px;
}
}
.status {
text-align: center;
padding: 12px;
border-radius: 10px;
margin-bottom: 15px;
font-weight: 600;
font-size: 14px;
}
@media (min-width: 768px) {
.status {
padding: 10px;
margin-bottom: 20px;
font-size: 16px;
}
}
.loading-notice, .info-notice, .error-notice {
padding: 12px;
border-radius: 10px;
margin-bottom: 15px;
text-align: center;
font-size: 14px;
}
@media (min-width: 768px) {
.loading-notice, .info-notice, .error-notice {
padding: 15px;
margin-bottom: 20px;
font-size: 16px;
}
}
.loading-notice {
background: #d1ecf1;
color: #0c5460;
}
.config-section {
background: #f8f9fa;
border-radius: 10px;
padding: 15px;
margin-bottom: 15px;
}
@media (min-width: 768px) {
.config-section {
padding: 20px;
margin-bottom: 20px;
}
}
.config-section h3 {
margin-bottom: 12px;
color: #333;
font-size: 1.1em;
}
@media (min-width: 768px) {
.config-section h3 {
margin-bottom: 15px;
font-size: 1.2em;
}
}
.config-grid {
display: grid;
grid-template-columns: 1fr;
gap: 8px;
margin-bottom: 12px;
}
@media (min-width: 480px) {
.config-grid {
grid-template-columns: repeat(2, 1fr);
gap: 10px;
}
}
@media (min-width: 768px) {
.config-grid {
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
margin-bottom: 15px;
}
}
input, select, textarea {
width: 100%;
padding: 12px;
border: 2px solid #ddd;
border-radius: 8px;
font-size: 16px;
-webkit-appearance: none;
appearance: none;
font-family: inherit;
}
@media (min-width: 768px) {
input, select, textarea {
padding: 10px;
border-radius: 5px;
font-size: 14px;
}
}
input:focus, select:focus, textarea:focus {
outline: none;
border-color: #4a7c28;
box-shadow: 0 0 0 3px rgba(74, 124, 40, 0.1);
}
.button-group {
display: flex;
gap: 8px;
flex-wrap: wrap;
}
@media (min-width: 768px) {
.button-group {
gap: 10px;
}
}
button {
background: linear-gradient(135deg, #4a7c28 0%, #68a225 100%);
color: white;
border: none;
padding: 12px 16px;
border-radius: 8px;
font-size: 14px;
font-weight: 600;
cursor: pointer;
transition: transform 0.2s;
min-height: 44px;
flex: 1;
min-width: 120px;
}
@media (min-width: 768px) {
button {
padding: 10px 20px;
border-radius: 5px;
min-height: auto;
flex: initial;
min-width: auto;
}
}
button:hover:not(:disabled) {
transform: scale(1.02);
}
@media (min-width: 768px) {
button:hover:not(:disabled) {
transform: scale(1.05);
}
}
button:active {
transform: scale(0.98);
}
.status.connected {
background: #d4f4dd;
color: #2d5016;
}
.status.disconnected {
background: #f8d7da;
color: #721c24;
}
.status.connecting {
background: #fff3cd;
color: #856404;
}
button:disabled {
opacity: 0.5;
cursor: not-allowed;
}
.preset-btn {
background: white;
color: #4a7c28;
border: 2px solid #4a7c28;
}
.preset-btn:hover {
background: #4a7c28;
color: white;
}
.export-btn {
background: linear-gradient(135deg, #2d5016 0%, #5cb85c 100%);
}
.clear-btn {
background: linear-gradient(135deg, #8b6f47 0%, #b8a074 100%);
}
.stats-grid {
display: grid;
grid-template-columns: 1fr;
gap: 10px;
margin-bottom: 15px;
}
@media (min-width: 480px) {
.stats-grid {
grid-template-columns: repeat(2, 1fr);
}
}
@media (min-width: 768px) {
.stats-grid {
grid-template-columns: repeat(3, 1fr);
gap: 15px;
margin-bottom: 20px;
}
}
.stat-card {
background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
border-radius: 10px;
padding: 12px;
text-align: center;
}
@media (min-width: 768px) {
.stat-card {
padding: 15px;
}
}
.stat-label {
font-size: 0.8em;
color: #666;
margin-bottom: 5px;
line-height: 1.2;
}
@media (min-width: 768px) {
.stat-label {
font-size: 0.9em;
}
}
.stat-value {
font-size: 1.4em;
font-weight: bold;
color: #333;
}
@media (min-width: 768px) {
.stat-value {
font-size: 1.8em;
}
}
.sensors-grid {
display: grid;
grid-template-columns: 1fr;
gap: 15px;
margin-bottom: 15px;
}
@media (min-width: 768px) {
.sensors-grid {
grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
gap: 20px;
margin-bottom: 20px;
}
}
.sensor-card {
background: linear-gradient(135deg, #4a7c28 0%, #68a225 100%);
border-radius: 15px;
padding: 15px;
color: white;
box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
}
@media (min-width: 768px) {
.sensor-card {
padding: 20px;
box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}
}
.sensor-card h3 {
margin-bottom: 12px;
font-size: 1.1em;
}
@media (min-width: 768px) {
.sensor-card h3 {
margin-bottom: 15px;
font-size: 1.2em;
}
}
.water-level-display {
font-size: 2em;
font-weight: bold;
margin: 12px 0;
text-align: center;
line-height: 1;
}
@media (min-width: 768px) {
.water-level-display {
font-size: 2.5em;
margin: 15px 0;
}
}
.tank-visual {
width: 100%;
height: 100px;
background: rgba(255,255,255,0.2);
border-radius: 8px;
position: relative;
overflow: hidden;
margin: 12px 0;
}
@media (min-width: 768px) {
.tank-visual {
height: 120px;
border-radius: 10px;
margin: 15px 0;
}
}
.water-fill {
position: absolute;
bottom: 0;
width: 100%;
background: linear-gradient(180deg, #4fc3f7 0%, #29b6f6 100%);
transition: height 1s ease;
display: flex;
align-items: center;
justify-content: center;
color: white;
font-weight: bold;
font-size: 14px;
}
.sensor-info {
display: flex;
justify-content: space-between;
font-size: 0.8em;
opacity: 0.9;
flex-wrap: wrap;
gap: 8px;
}
@media (min-width: 768px) {
.sensor-info {
font-size: 0.9em;
flex-wrap: nowrap;
gap: 0;
}
}
.history-section {
background: white;
border-radius: 15px;
padding: 15px;
margin-bottom: 15px;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}
@media (min-width: 768px) {
.history-section {
padding: 20px;
margin-bottom: 20px;
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}
}
.history-section h3 {
margin-bottom: 12px;
color: #333;
font-size: 1.1em;
}
@media (min-width: 768px) {
.history-section h3 {
margin-bottom: 15px;
font-size: 1.2em;
}
}
.history-table {
width: 100%;
max-height: 250px;
overflow-y: auto;
-webkit-overflow-scrolling: touch;
border-radius: 8px;
border: 1px solid #ddd;
}
@media (min-width: 768px) {
.history-table {
max-height: 300px;
}
}
.history-table table {
width: 100%;
border-collapse: collapse;
font-size: 14px;
}
@media (min-width: 768px) {
.history-table table {
font-size: 16px;
}
}
.history-table th {
background: #4a7c28;
color: white;
padding: 8px 6px;
text-align: left;
position: sticky;
top: 0;
font-size: 12px;
white-space: nowrap;
}
@media (min-width: 768px) {
.history-table th {
padding: 10px;
font-size: 14px;
}
}
.history-table td {
padding: 6px;
border-bottom: 1px solid #ddd;
font-size: 12px;
white-space: nowrap;
}
@media (min-width: 768px) {
.history-table td {
padding: 8px;
font-size: 14px;
}
}
.message-log {
background: #f8f9fa;
border-radius: 10px;
padding: 12px;
margin-top: 15px;
max-height: 150px;
overflow-y: auto;
-webkit-overflow-scrolling: touch;
}
@media (min-width: 768px) {
.message-log {
padding: 15px;
margin-top: 20px;
max-height: 200px;
}
}
.message-log h3 {
margin-bottom: 8px;
color: #333;
font-size: 1em;
}
@media (min-width: 768px) {
.message-log h3 {
margin-bottom: 10px;
font-size: 1.1em;
}
}
.log-entry {
font-family: monospace;
font-size: 11px;
padding: 4px;
border-bottom: 1px solid #ddd;
word-wrap: break-word;
line-height: 1.3;
}
@media (min-width: 768px) {
.log-entry {
font-size: 12px;
padding: 5px;
}
}
.footer-info {
text-align: center;
color: #666;
font-size: 0.8em;
margin-top: 15px;
line-height: 1.4;
}
@media (min-width: 768px) {
.footer-info {
font-size: 0.9em;
margin-top: 20px;
}
}
.error-notice {
background: #f8d7da;
color: #721c24;
padding: 12px;
border-radius: 10px;
margin-bottom: 15px;
display: none;
font-size: 14px;
}
@media (min-width: 768px) {
.error-notice {
padding: 15px;
margin-bottom: 20px;
font-size: 16px;
}
}
.map-container {
background: white;
border-radius: 15px;
padding: 12px;
margin-bottom: 15px;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
position: relative;
}
@media (min-width: 768px) {
.map-container {
padding: 20px;
margin-bottom: 20px;
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}
}
.map-container h3 {
margin-bottom: 12px;
color: #333;
font-size: 1.1em;
}
@media (min-width: 768px) {
.map-container h3 {
margin-bottom: 15px;
font-size: 1.2em;
}
}
.info-notice {
background: #cce5ff;
color: #004085;
padding: 12px;
border-radius: 10px;
margin-bottom: 15px;
font-size: 14px;
}
@media (min-width: 768px) {
.info-notice {
padding: 15px;
margin-bottom: 20px;
font-size: 16px;
}
}
.water-fill > span { display: none; }

/* CHAT OVERLAY STYLES */
.chat-overlay {
position: absolute;
bottom: 20px;
right: 20px;
width: 350px;
max-width: calc(100% - 40px);
background: white;
border-radius: 15px;
box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
z-index: 1000;
display: flex;
flex-direction: column;
max-height: 500px;
}

@media (max-width: 768px) {
.chat-overlay {
width: 300px;
max-height: 400px;
bottom: 10px;
right: 10px;
}
}

.chat-header {
background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
color: white;
padding: 15px;
border-radius: 15px 15px 0 0;
font-weight: 600;
display: flex;
justify-content: space-between;
align-items: center;
cursor: pointer;
user-select: none;
}

.chat-minimize-btn {
background: rgba(255, 255, 255, 0.2);
border: none;
color: white;
width: 24px;
height: 24px;
border-radius: 50%;
cursor: pointer;
font-size: 18px;
display: flex;
align-items: center;
justify-content: center;
transition: background 0.2s;
}

.chat-minimize-btn:hover {
background: rgba(255, 255, 255, 0.3);
}

.chat-body {
flex: 1;
overflow-y: auto;
padding: 15px;
background: #f5f5f5;
min-height: 200px;
max-height: 300px;
}

.chat-message {
border-left: 4px solid #2196F3;
padding: 10px;
margin-bottom: 10px;
background: white;
border-radius: 8px;
box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.chat-message.urgent {
border-left-color: #f44336;
background: #ffebee;
}

.chat-message-header {
display: flex;
justify-content: space-between;
margin-bottom: 5px;
font-size: 12px;
}

.chat-message-user {
color: #1976D2;
font-weight: 600;
}

.chat-message-time {
color: #999;
}

.chat-message-text {
color: #333;
font-size: 14px;
line-height: 1.4;
word-wrap: break-word;
}

.chat-input-section {
padding: 12px;
background: white;
border-radius: 0 0 15px 15px;
border-top: 1px solid #ddd;
}

.chat-input-section input {
margin-bottom: 8px;
font-size: 13px;
padding: 8px;
}

.chat-input-section textarea {
margin-bottom: 8px;
font-size: 13px;
padding: 8px;
resize: none;
height: 60px;
}

.chat-input-section button {
width: 100%;
padding: 10px;
font-size: 13px;
min-height: auto;
}

.chat-quick-buttons {
display: flex;
gap: 5px;
margin-top: 5px;
}

.chat-quick-buttons button {
flex: 1;
padding: 6px;
font-size: 11px;
}

.chat-minimized {
max-height: 50px;
overflow: hidden;
}

.chat-minimized .chat-body,
.chat-minimized .chat-input-section {
display: none;
}

.chat-empty {
text-align: center;
color: #999;
padding: 20px;
font-size: 13px;
}

.chat-confirm {
background: #c8e6c9;
color: #2e7d32;
padding: 8px;
border-radius: 8px;
text-align: center;
font-size: 12px;
font-weight: 600;
margin-top: 8px;
display: none;
}
</style>
</head>
<body>
<div class="container">
<h1>ðŸŒŠ Water Level Monitor - 3 Sensors</h1>
<div id="status" class="status disconnected">Not Connected</div>
<div id="loadingNotice" class="loading-notice">
Loading MQTT library... Please wait...
</div>
<div id="errorNotice" class="error-notice"></div>
<div class="config-section">
<h3>MQTT Configuration</h3>
<div class="button-group">
<button class="preset-btn" onclick="setPreset('mosquitto')">Test Mosquitto (Secure)</button>
<button class="preset-btn" onclick="setPreset('hivemq')">HiveMQ Public</button>
<button class="preset-btn" onclick="setPreset('emqx')">EMQX Public</button>
</div>
<br>
<div class="config-grid">
<input type="text" id="broker" placeholder="Broker URL" value="test.mosquitto.org">
<input type="text" id="port" placeholder="Port" value="8081">
<input type="text" id="topic" placeholder="Topic" value="meshtastic/#">
<select id="maxPoints">
<option value="50">Keep last 50 readings</option>
<option value="100" selected>Keep last 100 readings</option>
<option value="200">Keep last 200 readings</option>
</select>
</div>
<div class="button-group">
<button id="connectBtn" onclick="connectMQTT()" disabled>Connect</button>
<button id="disconnectBtn" onclick="disconnectMQTT()" style="display:none;">Disconnect</button>
<button class="export-btn" onclick="exportData()">Export CSV</button>
<button class="clear-btn" onclick="clearData()">Clear Data</button>
</div>
</div>

<!-- SENSOR CARDS - NOW WITH 3 SENSORS -->
<div class="sensors-grid">
<div class="sensor-card">
<h3>Water Sensor 1</h3>
<div class="tank-visual">
<div class="water-fill" id="tank1" style="height: 0%">
<span id="percent1">0%</span>
</div>
</div>
<div class="water-level-display" id="level1">-- ft</div>
<div class="sensor-info">
<span>Node: <span id="node1">--</span></span>
<span>CPU: <span id="cpu1">--Â°C</span></span>
</div>
</div>
<div class="sensor-card">
<h3>Water Sensor 2</h3>
<div class="tank-visual">
<div class="water-fill" id="tank2" style="height: 0%">
<span id="percent2">0%</span>
</div>
</div>
<div class="water-level-display" id="level2">-- ft</div>
<div class="sensor-info">
<span>Node: <span id="node2">--</span></span>
<span>CPU: <span id="cpu2">--Â°C</span></span>
</div>
</div>
<div class="sensor-card">
<h3>Water Sensor 3</h3>
<div class="tank-visual">
<div class="water-fill" id="tank3" style="height: 0%">
<span id="percent3">0%</span>
</div>
</div>
<div class="water-level-display" id="level3">-- ft</div>
<div class="sensor-info">
<span>Node: <span id="node3">--</span></span>
<span>CPU: <span id="cpu3">--Â°C</span></span>
</div>
</div>
</div>

<!-- HISTORY TABLE - NOW WITH 3 COLUMNS -->
<div class="history-section">
<h3>Recent Readings</h3>
<div class="history-table">
<table>
<thead>
<tr>
<th>Time</th>
<th>Sensor 1 (ft)</th>
<th>Sensor 2 (ft)</th>
<th>Sensor 3 (ft)</th>
</tr>
</thead>
<tbody id="historyTableBody">
<tr><td colspan="4" style="text-align:center;">No data yet</td></tr>
</tbody>
</table>
</div>
</div>

<!-- MAP - NOW WITH 3 SENSOR MARKERS AND CHAT OVERLAY -->
<div class="map-container">
<h3>ðŸŒŠ Sensor Locations - Morro Bay, CA</h3>
<div style="position: relative; background: #f0f8ff; border-radius: 10px; overflow: hidden;">
<!-- YOUR MAP IMAGE -->
<img id="morroMap"
     src="morro-bay-map.jpg"
     alt="Morro Bay Map"
     style="width: 100%; height: auto; display: block;">

<!-- Overlay markers positioned over your image -->
<div style="position: absolute; top: 18%; left: 35%; transform: translate(-50%, -50%);">
  <div style="background: white; border: 3px solid #4a7c28; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #4a7c28; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">1</div>
  <div style="background: white; border: 2px solid #4a7c28; border-radius: 5px; padding: 5px; margin-top: 5px; text-align: center; font-size: 12px; font-weight: bold; color: #2d5016; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
    <span id="overlay-level-1">-- ft</span>
  </div>
</div>

<div style="position: absolute; top: 52%; left: 48%; transform: translate(-50%, -50%);">
  <div style="background: white; border: 3px solid #4a7c28; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #4a7c28; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">2</div>
  <div style="background: white; border: 2px solid #4a7c28; border-radius: 5px; padding: 5px; margin-top: 5px; text-align: center; font-size: 12px; font-weight: bold; color: #2d5016; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
    <span id="overlay-level-2">-- ft</span>
  </div>
</div>

<div style="position: absolute; top: 85%; left: 48%; transform: translate(-50%, -50%);">
  <div style="background: white; border: 3px solid #4a7c28; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #4a7c28; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">3</div>
  <div style="background: white; border: 2px solid #4a7c28; border-radius: 5px; padding: 5px; margin-top: 5px; text-align: center; font-size: 12px; font-weight: bold; color: #2d5016; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
    <span id="overlay-level-3">-- ft</span>
  </div>
</div>

<!-- CHAT OVERLAY BOX -->
<div class="chat-overlay" id="chatOverlay">
  <div class="chat-header" onclick="toggleChatMinimize()">
    <span>ðŸ’¬ User Coordination</span>
    <button class="chat-minimize-btn" id="chatMinimizeBtn">âˆ’</button>
  </div>
  
  <div class="chat-body" id="chatBody">
    <div class="chat-confirm" id="chatConfirm">
      âœ… Message sent
    </div>
  </div>
</div>
</div>

<!-- Location info boxes with live data -->
<div style="margin-top: 15px; padding: 15px; background: #f0f9f0; border-radius: 8px;">
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
<div style="text-align: center; padding: 10px; background: white; border-radius: 8px; border: 2px solid #4a7c28;">
<div style="color: #4a7c28; font-weight: bold; margin-bottom: 5px;">ðŸŒŠ Sensor 1 (North)</div>
<div style="color: #666; font-size: 11px;">35.2214Â°N, 120.5138Â°W</div>
<div style="color: #2d5016; font-size: 24px; font-weight: bold; margin-top: 5px;" id="map-level-1">-- ft</div>
<div style="color: #888; font-size: 12px;" id="map-cpu-1">CPU: --Â°C</div>
</div>
<div style="text-align: center; padding: 10px; background: white; border-radius: 8px; border: 2px solid #4a7c28;">
<div style="color: #4a7c28; font-weight: bold; margin-bottom: 5px;">ðŸŒŠ Sensor 2 (Central)</div>
<div style="color: #666; font-size: 11px;">35.1917Â°N, 120.5119Â°W</div>
<div style="color: #2d5016; font-size: 24px; font-weight: bold; margin-top: 5px;" id="map-level-2">-- ft</div>
<div style="color: #888; font-size: 12px;" id="map-cpu-2">CPU: --Â°C</div>
</div>
<div style="text-align: center; padding: 10px; background: white; border-radius: 8px; border: 2px solid #4a7c28;">
<div style="color: #4a7c28; font-weight: bold; margin-bottom: 5px;">ðŸŒŠ Sensor 3 (South)</div>
<div style="color: #666; font-size: 11px;">35.1800Â°N, 120.5100Â°W</div>
<div style="color: #2d5016; font-size: 24px; font-weight: bold; margin-top: 5px;" id="map-level-3">-- ft</div>
<div style="color: #888; font-size: 12px;" id="map-cpu-3">CPU: --Â°C</div>
</div>
</div>
</div>
</div>

<div class="message-log">
<h3>Message Log</h3>
<div id="messageLog">
<div class="log-entry">Waiting for MQTT library to load...</div>
</div>
</div>
<div class="footer-info">
Last Update: <span id="lastUpdate">Never</span> |
Total Readings: <span id="totalReadings">0</span>
</div>
</div>

<!-- MQTT Library from CDN -->
<script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
<script>
// Global variables - NOW WITH 3 SENSORS
let client = null;
let sensor1Data = { from: null, history: [], nodeId: null, min: null, max: null };
let sensor2Data = { from: null, history: [], nodeId: null, min: null, max: null };
let sensor3Data = { from: null, history: [], nodeId: null, min: null, max: null };
let userMessages = [];
let maxDataPoints = 100;
const MAX_TANK_HEIGHT = 10; // feet
let mqttAvailable = false;
let autoConnectTriggered = false;
const isHTTPS = window.location.protocol === 'https:';

function loadMQTTFallback() {
const script = document.createElement('script');
script.src = 'https://cdn.jsdelivr.net/npm/mqtt@4.3.7/dist/mqtt.min.js';
script.onload = function() {
checkMQTT();
};
script.onerror = function() {
showError('Unable to load MQTT library. Please check your internet connection.');
document.getElementById('loadingNotice').style.display = 'none';
};
document.head.appendChild(script);
}

function checkMQTT() {
if (typeof mqtt !== 'undefined') {
mqttAvailable = true;
document.getElementById('connectBtn').disabled = false;
document.getElementById('loadingNotice').style.display = 'none';
addLog('MQTT library loaded successfully');
addLog('Ready to connect to MQTT broker');
if (isHTTPS) {
addLog('Running on HTTPS - using secure WebSocket (WSS)');
}
if (!autoConnectTriggered && !client) {
autoConnectTriggered = true;
addLog('Auto-connecting to default broker...');
setTimeout(connectMQTT, 1000);
}
} else {
setTimeout(loadMQTTFallback, 1000);
}
}

window.addEventListener('load', function() {
setTimeout(checkMQTT, 500);
// Load saved username
const savedName = localStorage.getItem('dashboardUserName');
if (savedName) {
document.getElementById('chatUserName').value = savedName;
}
});

function setPreset(preset) {
const configs = {
mosquitto: {
broker: 'test.mosquitto.org',
port: '8081',
topic: 'meshtastic/#'
},
hivemq: {
broker: 'broker.hivemq.com',
port: '8884',
topic: 'meshtastic/#'
},
emqx: {
broker: 'broker.emqx.io',
port: '8084',
topic: 'meshtastic/#'
}
};
if (configs[preset]) {
document.getElementById('broker').value = configs[preset].broker;
document.getElementById('port').value = configs[preset].port;
document.getElementById('topic').value = configs[preset].topic;
addLog(`Preset: ${preset} selected (secure connection)`);
}
}

function connectMQTT() {
if (!mqttAvailable || typeof mqtt === 'undefined') {
alert('MQTT library not loaded. Please refresh the page.');
return;
}
try {
const broker = document.getElementById('broker').value;
let port = document.getElementById('port').value;
const topic = document.getElementById('topic').value;
maxDataPoints = parseInt(document.getElementById('maxPoints').value);
if (!broker || !port) {
alert('Please enter broker and port');
return;
}
document.getElementById('status').className = 'status connecting';
document.getElementById('status').textContent = 'Connecting...';
if (client) {
client.end();
}
let protocol = 'wss';
if (!isHTTPS && (port === '8080' || port === '1883')) {
protocol = 'ws';
} else {
protocol = 'wss';
if (port === '8080') {
port = '8081';
addLog('Auto-corrected port 8080 to 8081 for secure connection');
document.getElementById('port').value = '8081';
} else if (port === '1883') {
port = '8883';
addLog('Auto-corrected port 1883 to 8883 for secure connection');
document.getElementById('port').value = '8883';
}
}
const url = `${protocol}://${broker}:${port}/mqtt`;
addLog(`Connecting to ${url} (${protocol.toUpperCase()})`);
client = mqtt.connect(url, {
clientId: 'water-' + Math.random().toString(16).substr(2, 8),
clean: true,
connectTimeout: 10000,
reconnectPeriod: 5000
});
client.on('connect', function() {
document.getElementById('status').className = 'status connected';
document.getElementById('status').textContent = `Connected to ${broker}:${port}`;
document.getElementById('connectBtn').style.display = 'none';
document.getElementById('disconnectBtn').style.display = 'inline-block';
document.getElementById('sendChatBtn').disabled = false;
client.subscribe(topic, function(err) {
if (!err) {
addLog(`Subscribed to: ${topic}`);
addLog('Waiting for water sensor messages...');
// Subscribe to user messages topic
client.subscribe('meshtastic/user-messages', function(err2) {
if (!err2) {
addLog('Subscribed to user messages topic');
updateChatEmpty('Waiting for messages...');
}
});
} else {
addLog(`Subscribe error: ${err.message}`);
}
});
});
client.on('message', function(topic, message) {
try {
const data = JSON.parse(message.toString());
// Handle user messages
if (data.type === 'user_message') {
displayUserMessage(data);
return;
}
// Handle sensor data
if (data.type === 'text' && data.payload && data.payload.text) {
const text = data.payload.text;
addLog(`Topic: ${topic}`);
addLog(`Message: ${text}`);
let match = text.match(/([\d.]+)\s*feet/i) ||
text.match(/([\d.]+)\s*ft/i) ||
text.match(/Level:\s*([\d.]+)/i);
let cpuMatch = text.match(/CPU:\s*([\d.]+)Â°C/i);
if (match) {
const level = parseFloat(match[1]);
const cpu = cpuMatch ? parseFloat(cpuMatch[1]) : null;
const nodeId = topic.split('/').pop();
if (!sensor1Data.from) {
sensor1Data.from = data.from;
sensor1Data.nodeId = nodeId;
addLog(`Sensor 1 assigned to node: ${data.from}`);
}
if (data.from === sensor1Data.from) {
updateSensor(1, level, cpu, nodeId);
} else if (!sensor2Data.from) {
sensor2Data.from = data.from;
sensor2Data.nodeId = nodeId;
addLog(`Sensor 2 assigned to node: ${data.from}`);
updateSensor(2, level, cpu, nodeId);
} else if (data.from === sensor2Data.from) {
updateSensor(2, level, cpu, nodeId);
} else if (!sensor3Data.from) {
sensor3Data.from = data.from;
sensor3Data.nodeId = nodeId;
addLog(`Sensor 3 assigned to node: ${data.from}`);
updateSensor(3, level, cpu, nodeId);
} else if (data.from === sensor3Data.from) {
updateSensor(3, level, cpu, nodeId);
}
}
}
} catch (e) {
}
});
client.on('error', function(err) {
document.getElementById('status').className = 'status disconnected';
document.getElementById('status').textContent = 'Connection Error';
document.getElementById('connectBtn').style.display = 'inline-block';
document.getElementById('disconnectBtn').style.display = 'none';
document.getElementById('sendChatBtn').disabled = true;
let errorMsg = err.message || err;
if (errorMsg.includes('WebSocket') && isHTTPS) {
errorMsg += ' - Try using port 8081 (secure) instead of 8080';
}
addLog(`Error: ${errorMsg}`);
showError(errorMsg);
});
client.on('offline', function() {
document.getElementById('status').className = 'status disconnected';
document.getElementById('status').textContent = 'Offline';
document.getElementById('sendChatBtn').disabled = true;
});
} catch (e) {
console.error('Connection error:', e);
let errorMsg = e.message;
if (errorMsg.includes('WebSocket') && errorMsg.includes('insecure')) {
errorMsg = 'Security Error: Please use port 8081 for test.mosquitto.org or try HiveMQ preset';
}
showError(errorMsg);
}
}

function disconnectMQTT() {
if (client) {
client.end();
document.getElementById('status').className = 'status disconnected';
document.getElementById('status').textContent = 'Disconnected';
document.getElementById('connectBtn').style.display = 'inline-block';
document.getElementById('disconnectBtn').style.display = 'none';
document.getElementById('sendChatBtn').disabled = true;
addLog('Disconnected');
}
}

function updateSensor(num, level, cpu, nodeId) {
try {
const timestamp = new Date();
const sensorData = num === 1 ? sensor1Data : (num === 2 ? sensor2Data : sensor3Data);
const displayValue = Math.max(0, level);
document.getElementById(`level${num}`).textContent = `${displayValue.toFixed(1)} ft`;
document.getElementById(`stat${num}`).textContent = `${displayValue.toFixed(1)} ft`;
if (nodeId) {
document.getElementById(`node${num}`).textContent = nodeId.substring(0, 10);
}
if (cpu !== null) {
document.getElementById(`cpu${num}`).textContent = `${cpu}Â°C`;
}
if (sensorData.min === null || displayValue < sensorData.min) {
sensorData.min = displayValue;
}
if (sensorData.max === null || displayValue > sensorData.max) {
sensorData.max = displayValue;
}
const percent = Math.min(100, Math.max(0, (displayValue / MAX_TANK_HEIGHT) * 100));
document.getElementById(`tank${num}`).style.height = `${percent}%`;
const p = document.getElementById(`percent${num}`);
if (p) p.textContent = `${Math.round(percent)}%`;
sensorData.history.push({
time: timestamp,
level: displayValue,
cpu: cpu
});
if (sensorData.history.length > maxDataPoints) {
sensorData.history.shift();
}
updateHistoryTable();
const mapLevel = document.getElementById(`map-level-${num}`);
if (mapLevel) {
mapLevel.textContent = `${displayValue.toFixed(1)} ft`;
}
const overlayLevel = document.getElementById(`overlay-level-${num}`);
if (overlayLevel) {
overlayLevel.textContent = `${displayValue.toFixed(1)} ft`;
}
const mapCpu = document.getElementById(`map-cpu-${num}`);
if (mapCpu && cpu !== null) {
mapCpu.textContent = `CPU: ${cpu.toFixed(0)}Â°C`;
}
document.getElementById('lastUpdate').textContent = timestamp.toLocaleTimeString();
document.getElementById('totalReadings').textContent =
sensor1Data.history.length + sensor2Data.history.length + sensor3Data.history.length;
} catch (e) {
console.error('Update sensor error:', e);
}
}

function updateHistoryTable() {
const tbody = document.getElementById('historyTableBody');
const combined = [
...sensor1Data.history.map(d => ({ t: d.time, s: 1, level: d.level })),
...sensor2Data.history.map(d => ({ t: d.time, s: 2, level: d.level })),
...sensor3Data.history.map(d => ({ t: d.time, s: 3, level: d.level })),
];
const bySec = new Map();
combined.forEach(d => {
if (!d || !d.t) return;
const key = Math.floor(new Date(d.t).getTime() / 1000);
if (!bySec.has(key)) bySec.set(key, { t: new Date(key * 1000), s1: null, s2: null, s3: null });
const row = bySec.get(key);
if (d.s === 1 && row.s1 == null) row.s1 = d.level;
if (d.s === 2 && row.s2 == null) row.s2 = d.level;
if (d.s === 3 && row.s3 == null) row.s3 = d.level;
});
const rowsArr = Array.from(bySec.values()).sort((a, b) => b.t - a.t).slice(0, 20);
const rows = rowsArr.map(r => `
<tr>
<td>${r.t.toLocaleTimeString()}</td>
<td>${r.s1 != null ? r.s1.toFixed(1) : ''}</td>
<td>${r.s2 != null ? r.s2.toFixed(1) : ''}</td>
<td>${r.s3 != null ? r.s3.toFixed(1) : ''}</td>
</tr>
`).join('');
tbody.innerHTML = rows || '<tr><td colspan="4" style="text-align:center;">No data yet</td></tr>';
}

function exportData() {
try {
const combined = [
...sensor1Data.history.map(d => ({ t: d.time, s: 1, level: d.level })),
...sensor2Data.history.map(d => ({ t: d.time, s: 2, level: d.level })),
...sensor3Data.history.map(d => ({ t: d.time, s: 3, level: d.level })),
];
const bySec = new Map();
combined.forEach(d => {
if (!d || !d.t) return;
const key = Math.floor(new Date(d.t).getTime() / 1000);
if (!bySec.has(key)) bySec.set(key, { t: new Date(key * 1000), s1: null, s2: null, s3: null });
const row = bySec.get(key);
if (d.s === 1 && row.s1 == null) row.s1 = d.level;
if (d.s === 2 && row.s2 == null) row.s2 = d.level;
if (d.s === 3 && row.s3 == null) row.s3 = d.level;
});
const rowsArr = Array.from(bySec.values()).sort((a, b) => a.t - b.t);
let csv = 'Timestamp,Sensor 1 (ft),Sensor 2 (ft),Sensor 3 (ft)\n';
rowsArr.forEach(r => {
const s1 = r.s1 != null ? r.s1.toFixed(2) : '';
const s2 = r.s2 != null ? r.s2.toFixed(2) : '';
const s3 = r.s3 != null ? r.s3.toFixed(2) : '';
csv += `${r.t.toISOString()},${s1},${s2},${s3}\n`;
});
const blob = new Blob([csv], { type: 'text/csv' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = `water-levels-3sensors-${new Date().toISOString().split('T')[0]}.csv`;
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);
addLog('Data exported to CSV');
} catch (e) {
console.error('Export error:', e);
showError('Export failed: ' + e.message);
}
}

function clearData() {
if (confirm('Clear all data? This cannot be undone.')) {
sensor1Data.history = [];
sensor1Data.min = null;
sensor1Data.max = null;
sensor2Data.history = [];
sensor2Data.min = null;
sensor2Data.max = null;
sensor3Data.history = [];
sensor3Data.min = null;
sensor3Data.max = null;
updateHistoryTable();
addLog('Data cleared');
}
}

function addLog(message) {
try {
const log = document.getElementById('messageLog');
const entry = document.createElement('div');
entry.className = 'log-entry';
entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
log.insertBefore(entry, log.firstChild);
while (log.children.length > 20) {
log.removeChild(log.lastChild);
}
} catch (e) {
console.error('Log error:', e);
}
}

function showError(message) {
const errorDiv = document.getElementById('errorNotice');
if (errorDiv) {
errorDiv.textContent = 'âš ï¸ ' + message;
errorDiv.style.display = 'block';
setTimeout(() => {
errorDiv.style.display = 'none';
}, 10000);
}
console.error(message);
}

// ========================================
// CHAT FUNCTIONS
// ========================================

function sendUserMessage() {
if (!client || !client.connected) {
alert('Not connected to MQTT broker. Please connect first.');
return;
}
const userName = document.getElementById('chatUserName').value.trim();
const messageText = document.getElementById('chatMessageInput').value.trim();
if (!userName) {
alert('Please enter your name first.');
document.getElementById('chatUserName').focus();
return;
}
if (!messageText) {
alert('Please enter a message to send.');
document.getElementById('chatMessageInput').focus();
return;
}
const messagePayload = JSON.stringify({
type: 'user_message',
from: userName,
message: messageText,
timestamp: new Date().toISOString(),
location: 'Morro Bay Dashboard'
});
const topic = 'meshtastic/user-messages';
client.publish(topic, messagePayload, { qos: 1 }, function(err) {
if (err) {
addLog(`âŒ Failed to send message: ${err.message}`);
alert('Failed to send message. Check your connection.');
} else {
addLog(`ðŸ’¬ Message sent by ${userName}`);
const confirm = document.getElementById('chatConfirm');
confirm.style.display = 'block';
setTimeout(() => {
confirm.style.display = 'none';
}, 2000);
document.getElementById('chatMessageInput').value = '';
localStorage.setItem('dashboardUserName', userName);
}
});
}

function sendQuickMessage(message) {
document.getElementById('chatMessageInput').value = message;
sendUserMessage();
}

function displayUserMessage(data) {
const chatBody = document.getElementById('chatBody');
// Remove empty placeholder
const empty = chatBody.querySelector('.chat-empty');
if (empty) {
empty.remove();
}
const msgDiv = document.createElement('div');
msgDiv.className = 'chat-message';
const timestamp = new Date(data.timestamp);
const timeStr = timestamp.toLocaleTimeString();
const isUrgent = data.message.toLowerCase().includes('emergency') ||
data.message.toLowerCase().includes('urgent') ||
data.message.toLowerCase().includes('alert') ||
data.message.toLowerCase().includes('ðŸš¨');
if (isUrgent) {
msgDiv.classList.add('urgent');
}
msgDiv.innerHTML = `
<div class="chat-message-header">
<span class="chat-message-user">${escapeHtml(data.from)}</span>
<span class="chat-message-time">${timeStr}</span>
</div>
<div class="chat-message-text">${escapeHtml(data.message)}</div>
`;
chatBody.insertBefore(msgDiv, chatBody.firstChild);
userMessages.push(data);
if (userMessages.length > 50) {
userMessages.shift();
if (chatBody.children.length > 50) {
chatBody.removeChild(chatBody.lastChild);
}
}
addLog(`ðŸ’¬ ${data.from}: ${data.message}`);
}

function escapeHtml(text) {
const div = document.createElement('div');
div.textContent = text;
return div.innerHTML;
}

function updateChatEmpty(text) {
const chatBody = document.getElementById('chatBody');
const empty = chatBody.querySelector('.chat-empty');
if (empty) {
empty.textContent = text;
}
}

function toggleChatMinimize() {
const chat = document.getElementById('chatOverlay');
const btn = document.getElementById('chatMinimizeBtn');
chat.classList.toggle('chat-minimized');
btn.textContent = chat.classList.contains('chat-minimized') ? '+' : 'âˆ’';
}

// Allow Enter to send (Shift+Enter for new line)
document.addEventListener('DOMContentLoaded', function() {
const messageInput = document.getElementById('chatMessageInput');
if (messageInput) {
messageInput.addEventListener('keypress', function(e) {
if (e.key === 'Enter' && !e.shiftKey) {
e.preventDefault();
sendUserMessage();
}
});
}
});
</script>
</body>
</html>chat-empty">
      Connect to MQTT to see messages
    </div>
  </div>
  
  <div class="chat-input-section">
    <input type="text" id="chatUserName" placeholder="Your name...">
    <textarea id="chatMessageInput" placeholder="Type message..."></textarea>
    <button onclick="sendUserMessage()" id="sendChatBtn" disabled style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);">
      Send
    </button>
    <div class="chat-quick-buttons">
      <button class="preset-btn" onclick="sendQuickMessage('ðŸš¨ Emergency protocol activated')">ðŸš¨ Alert</button>
      <button class="preset-btn" onclick="sendQuickMessage('âœ… All clear')">âœ… Clear</button>
    </div>
    <div class="